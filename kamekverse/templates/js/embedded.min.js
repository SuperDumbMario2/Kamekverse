var Miiverse = Miiverse || {uri: "{{ request.get_host }}"};

!function(a){
    // Function to parse URLs and extract info
    function b(b){
        console.log("[DEBUG] Parsing URL:", b);

        var c = document.createElement("a");
        c.href = b;

        var d, e = c.hostname, f = c.pathname;
        console.log("[DEBUG] Hostname:", e, "Pathname:", f);

        var g = f.match(/^\/?posts\/([0-9A-Za-z\-_]+)$/);
        if(g && g[1]){
            d = g[1];
            console.log("[DEBUG] Found postId:", d);
        } else {
            console.log("[DEBUG] No postId found in URL");
        }

        var isMine = (e === a.uri.split(':')[0]);
        console.log("[DEBUG] IsMine:", isMine);

        return {host: e, path: f, postId: d, isMine: isMine};
    }

    // Function to handle messages from iframes
    function c(a){
        console.log("[DEBUG] Received message event:", a);

        var info = b(a.origin);
        if(info.isMine){
            console.log("[DEBUG] Message is from our domain");

            var d = {};
            var e = a.data.split(/\s*,\s*/);
            console.log("[DEBUG] Split message data:", e);

            for(var f = 0, g; g = e[f]; f++){
                var h = g.split(/\s*:\s*/);
                if(h[0] && h[1]){
                    d[h[0]] = h[1];
                    console.log("[DEBUG] Parsed key-value:", h[0], "=", h[1]);
                }
            }

            var h = d.height;
            if(h && isFinite(h)){
                console.log("[DEBUG] Adjusting iframe height to:", h);
                var i, j = document.getElementsByTagName("iframe");
                for(var f2 = 0; i = j[f2]; f2++){
                    if(a.source == i.contentWindow){
                        i.scrolling = "no";
                        i.style.height = h + "px";
                        console.log("[DEBUG] Height set on iframe:", i);
                        break;
                    }
                }
            } else {
                console.log("[DEBUG] No valid height found in message");
            }
        } else {
            console.log("[DEBUG] Message origin is not from our domain");
        }
    }

    // Post-handling object
    a.Post || (a.Post = {
        tryCreate: function(c){
            console.log("[DEBUG] Trying to create post for element:", c);
            var d = c.getAttribute("data-miiverse-cite");
            console.log("[DEBUG] data-miiverse-cite:", d);

            var e = b(d);
            if(e.isMine && e.postId){
                console.log("[DEBUG] Replacing element with iframe for postId:", e.postId);
                a.Post.replaceElement(c, e.postId, d + "/embed");
            } else {
                console.log("[DEBUG] Element is not from our domain or has no postId");
            }
        },

        setup: function(){
            console.log("[DEBUG] Setting up all Miiverse posts on page");
            var b, c = document.querySelectorAll ? document.querySelectorAll("div.miiverse-post") : document.getElementsByTagName("div");
            var d = [], e = /(?:^|\s)miiverse-post(?:\s|$)/;

            for(var f = 0; b = c[f]; f++){
                if(e.test(b.className)){
                    console.log("[DEBUG] Found miiverse-post div:", b);
                    d.push(b);
                }
            }

            var g;
            for(var h = 0; g = d[h]; h++){
                console.log("[DEBUG] Creating iframe for div:", g);
                a.Post.tryCreate(g);
            }
        },

        replaceElement: function(a, b, c){
            console.log("[DEBUG] Replacing div with iframe:", a, "postId:", b, "src:", c);
            var d = document.createElement("iframe");
            d.className = "miiverse-post-frame miiverse-post-" + b;
            d.src = c;
            d.style.display = "block";
            d.style.minWidth = "220px";
            d.style.maxWidth = "500px";
            d.style.width = "98%";
            d.style.padding = "0px";
            d.style.borderRadius = "5px";
            d.style.margin = "10px 0px";
            d.style.border = "1px solid #dddddd";
            d.style.boxShadow = "0px 1px 3px rgba(0, 0, 0, 0.3)";
            d.style.position = "static";
            d.style.visibility = "visible";

            console.log("[DEBUG] Replacing parent node child with iframe");
            a.parentNode.replaceChild(d, a);
            console.log("[DEBUG] Replacement done");
        }
    });

    if(window.addEventListener){
        console.log("[DEBUG] Adding message event listener (modern)");
        window.addEventListener("message", c, false);
    } else if(window.attachEvent){
        console.log("[DEBUG] Adding message event listener (IE fallback)");
        window.attachEvent("onmessage", c);
    }

}(Miiverse);

console.log("[DEBUG] Initializing Miiverse posts setup");
Miiverse.Post.setup();



// var Miiverse=Miiverse||{uri:"{{ request.get_host }}"};!function(a){function b(b){var c=document.createElement("a");c.href=b;var d,e=c.hostname,f=c.pathname,g=f.match(/^\/?posts\/([0-9A-Za-z\-_]+)$/);return g&&g[1]&&(d=g[1]),{host:e,path:f,postId:d,isMine:e===a.uri}}function c(a){if(b(a.origin).isMine){for(var c,d={},e=a.data.split(/\s*,\s*/),f=0;c=e[f];f++){var g=c.split(/\s*:\s*/);g[0]&&g[1]&&(d[g[0]]=g[1])}var h=d.height;if(h&&isFinite(h))for(var i,j=document.getElementsByTagName("iframe"),f=0;i=j[f];f++)if(a.source==i.contentWindow){i.scrolling="no",i.style.height=h+"px";break}}}a.Post||(a.Post={tryCreate:function(c){var d=c.getAttribute("data-miiverse-cite"),e=b(d);e.isMine&&e.postId&&a.Post.replaceElement(c,e.postId,d+"/embed")},setup:function(){for(var b,c=document.querySelectorAll?document.querySelectorAll("div.miiverse-post"):document.getElementsByTagName("div"),d=[],e=/(?:^|\s)miiverse-post(?:\s|$)/,f=0;b=c[f];f++)e.test(b.className)&&d.push(b);for(var g,h=0;g=d[h];h++)a.Post.tryCreate(g)},replaceElement:function(a,b,c){var d=document.createElement("iframe");d.className="miiverse-post-frame miiverse-post-"+b,d.src=c,d.style.display="block",d.style.minWidth="220px",d.style.maxWidth="500px",d.style.width="98%",d.style.padding="0px",d.style.borderRadius="5px",d.style.margin="10px 0px",d.style.border="1px solid #dddddd",d.style.boxShadow="0px 1px 3px rgba(0, 0, 0, 0.3)",d.style.position="static",d.style.visibility="visible",a.parentNode.replaceChild(d,a)}},window.addEventListener?window.addEventListener("message",c,!1):window.attachEvent&&window.attachEvent("onmessage",c))}(Miiverse),Miiverse.Post.setup();